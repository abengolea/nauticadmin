rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // Check for the DB flag OR the specific bootstrap email.
      // This makes the rule resilient if the DB flag is missing for the bootstrap user.
      let platformUserData = get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data;
      return isSignedIn()
          && (
            (platformUserData != null && platformUserData.super_admin == true)
            || request.auth.token.email == 'abengolea1@gmail.com'
          );
    }

    function userExistsInSchool(schoolId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid));
    }

    function getSchoolUserData(schoolId) {
      return userExistsInSchool(schoolId)
          ? get(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)).data
          : null;
    }

    function isSchoolAdmin(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'school_admin';
    }

    function isCoach(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'coach';
    }

    function isMemberOfSchool(schoolId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid));
    }
    
    // --- Schema Validation Helpers ---

    function isValidSchoolUserRole(role) {
      return role in ['school_admin', 'coach'];
    }

    // --- Rules ---
    
    // CRÍTICO: Permite que un usuario busque sus propios roles en CUALQUIER escuela.
    // Necesario para la collectionGroup query que se ejecuta al iniciar sesión.
    match /{path=**}/users/{userId} {
      allow read: if isSignedIn() && resource.data.email == request.auth.token.email;
    }

    match /platformUsers/{userId} {
      // Un usuario puede leer su propio documento. Un super admin puede leer cualquiera.
      allow read: if isSignedIn() && (isSuperAdmin() || request.auth.uid == userId);
      
      // Allow creation if:
      // 1. The caller is a super admin.
      // 2. The caller is any signed-in user, as long as they are not granting super_admin rights.
      //    This allows school_admins to create the necessary platform user doc for new school users.
      // 3. The bootstrap user is creating their own super_admin profile for the first time.
      allow create: if isSuperAdmin() ||
                     (isSignedIn() && request.resource.data.super_admin == false) ||
                     (
                       isSignedIn() &&
                       request.auth.uid == userId &&
                       request.auth.token.email == 'abengolea1@gmail.com' && 
                       request.resource.data.super_admin == true
                     );

      // Un super admin puede actualizar cualquier perfil.
      // Un usuario puede actualizar su propio documento, pero no darse permisos de super admin.
      allow update: if isSignedIn() && (
        isSuperAdmin() || 
        (request.auth.uid == userId && !('super_admin' in request.resource.data))
      );
    }

    match /schools/{schoolId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isCoach(schoolId);
      allow create, update: if isSuperAdmin();
      allow delete: if false; // Soft delete
    }
    
    match /schools/{schoolId}/users/{userId} {
        // A user can read their own user document, an admin of that school can read any, and a super admin can read any.
        allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || request.auth.uid == userId;
        // Admins can write, but only valid roles.
        allow create, update: if (isSuperAdmin() || isSchoolAdmin(schoolId)) && isValidSchoolUserRole(request.resource.data.role);
        allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/players/{playerId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isCoach(schoolId);
      // Coaches can create/update, but only admins can delete.
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/pendingPlayers/{pendingId} {
        // Super admin, miembros de la escuela, o admins/entrenadores pueden leer y eliminar.
        allow read, delete: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isCoach(schoolId);
        // Allow any signed-in user to create a request. This can be tightened later if needed.
        allow create: if isSignedIn();
    }

    match /schools/{schoolId}/evaluations/{evalId} {
      // get = documento individual; list = listar la colección (queries).
      allow get, list: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isCoach(schoolId);
      // A coach can create an evaluation only for an assigned category.
      allow create: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      // On update, a coach cannot change the categoryId and must be assigned to the original category.
      allow update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // --- Other collections ---

    match /schools/{schoolId}/trainings/{trainingId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isCoach(schoolId);
      allow create: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      allow update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/trainings/{trainingId}/attendance/{playerId} {
      // The coach must be assigned to the training's category.
      allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
    }
    
    match /schools/{schoolId}/invites/{inviteId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
     match /schools/{schoolId}/testTemplates/{templateId} {
        allow read: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isCoach(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/reportRuns/{runId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/reports/{reportId} {
        allow read: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isCoach(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
  }
}
