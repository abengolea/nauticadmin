rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isSignedIn()
          && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.super_admin == true;
    }

    function getSchoolUserData(schoolId) {
      return get(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)).data;
    }

    function isSchoolAdmin(schoolId) {
      // getSchoolUserData().role fallará si el documento no existe, por eso se comprueba que no sea nulo.
      // Este helper es ineficiente (2 lecturas) pero sintácticamente correcto.
      return isSignedIn()
          && getSchoolUserData(schoolId) != null
          && getSchoolUserData(schoolId).role == 'school_admin';
    }

    function isCoach(schoolId) {
      return isSignedIn()
          && getSchoolUserData(schoolId) != null
          && getSchoolUserData(schoolId).role == 'coach';
    }

    function isMemberOfSchool(schoolId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid));
    }
    
    // Función corregida: Sin 'if' o 'let'. Combinada en una única expresión booleana.
    function isAssignedToCategory(schoolId, categoryId) {
      return isCoach(schoolId) && categoryId in getSchoolUserData(schoolId).assignedCategories;
    }

    // --- Schema Validation Helpers ---

    function isValidSchoolUserRole(role) {
      return role in ['school_admin', 'coach'];
    }

    function isCategoryIdUnchanged() {
      return request.resource.data.categoryId == resource.data.categoryId;
    }

    // --- Rules ---

    match /platformUsers/{userId} {
      allow read: if isSignedIn() && (isSuperAdmin() || request.auth.uid == userId);
      
      // Regla de bootstrap: permite al email específico auto-crearse como super admin la primera vez.
      allow create: if isSignedIn() && request.auth.uid == userId 
        && (
          (request.auth.token.email == 'abengolea1@gmail.com' && request.resource.data.super_admin == true) ||
          (request.auth.token.email != 'abengolea1@gmail.com' && !('super_admin' in request.resource.data))
        );

      // Un usuario puede actualizar su propio doc, pero no darse super_admin. Solo un super_admin puede hacerlo.
      allow update: if isSignedIn() && (
        isSuperAdmin() || 
        (request.auth.uid == userId && !('super_admin' in request.resource.data))
      );
    }

    match /schools/{schoolId} {
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      allow create, update: if isSuperAdmin();
      allow delete: if false; // Soft delete
    }
    
    match /schools/{schoolId}/users/{userId} {
        allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || request.auth.uid == userId;
        // Admins pueden escribir, pero solo roles válidos.
        allow create, update: if (isSuperAdmin() || isSchoolAdmin(schoolId)) && isValidSchoolUserRole(request.resource.data.role);
        allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/categories/{categoryId} {
        allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
        allow create, update, delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/players/{playerId} {
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      // Coaches pueden crear/actualizar, pero solo admins pueden borrar.
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isCoach(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/evaluations/{evalId} {
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      // Un coach puede crear una evaluación solo para una categoría asignada.
      allow create: if isSuperAdmin() || isSchoolAdmin(schoolId) || (isCoach(schoolId) && isAssignedToCategory(schoolId, request.resource.data.categoryId));
      // En update, un coach no puede cambiar el categoryId y debe estar asignado a la categoría original.
      allow update: if isSuperAdmin() || isSchoolAdmin(schoolId) || (isCoach(schoolId) && isCategoryIdUnchanged() && isAssignedToCategory(schoolId, resource.data.categoryId));
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // --- Otras colecciones (con reglas mejoradas) ---

    match /schools/{schoolId}/trainings/{trainingId} {
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      allow create: if isSuperAdmin() || isSchoolAdmin(schoolId) || (isCoach(schoolId) && isAssignedToCategory(schoolId, request.resource.data.categoryId));
      allow update: if isSuperAdmin() || isSchoolAdmin(schoolId) || (isCoach(schoolId) && isCategoryIdUnchanged() && isAssignedToCategory(schoolId, resource.data.categoryId));
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/trainings/{trainingId}/attendance/{playerId} {
      // El coach debe estar asignado a la categoría del entrenamiento.
      allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId) || (isCoach(schoolId) && isAssignedToCategory(schoolId, get(/databases/$(database)/documents/schools/$(schoolId)/trainings/$(trainingId)).data.categoryId));
    }
    
    match /schools/{schoolId}/invites/{inviteId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
     match /schools/{schoolId}/testTemplates/{templateId} {
        allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/reportRuns/{runId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/reports/{reportId} {
        allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
  }
}
