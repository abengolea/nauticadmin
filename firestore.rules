rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isSignedIn() && (
        (exists(/databases/$(database)/documents/platformUsers/$(request.auth.uid))
          && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.get('super_admin', false) == true)
        || request.auth.token.email == 'abengolea1@gmail.com'
      );
    }

    function userExistsInSchool(schoolId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid));
    }

    function getSchoolUserData(schoolId) {
      return userExistsInSchool(schoolId)
          ? get(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)).data
          : null;
    }

    function isSchoolAdmin(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'school_admin';
    }

    function isOperador(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'operador';
    }

    function isMemberOfSchool(schoolId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid));
    }

    // True si el usuario es el jugador (el doc de jugador tiene su email). Comparación case-insensitive.
    function isOwnPlayer(schoolId, playerId) {
      return isSignedIn()
        && request.auth.token.email != null
        && exists(/databases/$(database)/documents/schools/$(schoolId)/players/$(playerId))
        && get(/databases/$(database)/documents/schools/$(schoolId)/players/$(playerId)).data.get('email', '').lower() == request.auth.token.email.lower();
    }
    // True si en este request se está guardando el email del usuario autenticado (jugador editando su perfil).
    function requestEmailMatchesAuth(schoolId, playerId) {
      let reqEmail = request.resource.data.get('email', '');
      return isSignedIn()
        && request.auth.token.email != null
        && reqEmail != null
        && reqEmail is string
        && reqEmail.lower() == request.auth.token.email.lower();
    }
    // True si el usuario es el jugador (doc ya tiene su email). Comparación case-insensitive.
    function canUpdatePlayerAsSelf(schoolId, playerId) {
      return isSignedIn()
        && request.auth.token.email != null
        && (isOwnPlayer(schoolId, playerId) || requestEmailMatchesAuth(schoolId, playerId));
    }
    // True si el usuario tiene un playerLogin que apunta a este schoolId+playerId.
    function hasPlayerLoginFor(schoolId, playerId) {
      return isSignedIn()
        && request.auth.token.email != null
        && exists(/databases/$(database)/documents/playerLogins/$(request.auth.token.email.lower()))
        && get(/databases/$(database)/documents/playerLogins/$(request.auth.token.email.lower())).data.get('schoolId', '') == schoolId
        && get(/databases/$(database)/documents/playerLogins/$(request.auth.token.email.lower())).data.get('playerId', '') == playerId;
    }
    
    // --- Schema Validation Helpers ---

    function isValidSchoolUserRole(role) {
      return role in ['school_admin', 'operador', 'editor', 'viewer'];
    }

    function isEditor(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'editor';
    }

    function isViewer(schoolId) {
      let userData = getSchoolUserData(schoolId);
      return isSignedIn()
          && userData != null
          && userData.role == 'viewer';
    }

    function isStaffOfSchool(schoolId) {
      return isSuperAdmin()
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || isEditor(schoolId)
          || isViewer(schoolId);
    }

    // --- Rules ---
    
    // CRÍTICO: Permite que un usuario busque sus propios roles en CUALQUIER escuela.
    // Necesario para la collectionGroup query que se ejecuta al iniciar sesión.
    match /{path=**}/users/{userId} {
      allow read: if isSignedIn() && resource.data.email == request.auth.token.email;
    }

    // Colección para Trigger Email (extensión firestore-send-email). Solo crear; la extensión actualiza estado.
    match /mail/{mailId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false;
    }

    // Solicitudes de acceso: usuario logueado sin perfil pide ser dado de alta como jugador.
    match /accessRequests/{requestId} {
      allow create: if isSignedIn();
      allow read, update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // Jugadores: mapa email (doc id) -> schoolId + playerId para que el jugador pueda iniciar sesión sin collection group.
    match /playerLogins/{emailKey} {
      allow read: if isSignedIn() && request.auth.token.email != null && emailKey == request.auth.token.email.lower();
      allow create, update: if isSuperAdmin()
        || (request.resource.data.schoolId != null && request.resource.data.playerId != null
            && (isOperador(request.resource.data.schoolId) || isSchoolAdmin(request.resource.data.schoolId)));
      allow delete: if isSuperAdmin()
        || (resource.data.schoolId != null && (isOperador(resource.data.schoolId) || isSchoolAdmin(resource.data.schoolId)));
    }

    match /platformUsers/{userId} {
      // Un usuario puede leer su propio documento. Un super admin puede leer cualquiera.
      allow read: if isSignedIn() && (isSuperAdmin() || request.auth.uid == userId);
      
      // Allow creation if:
      // 1. The caller is a super admin.
      // 2. The caller is any signed-in user, as long as they are not granting super_admin rights.
      //    This allows school_admins to create the necessary platform user doc for new school users.
      // 3. The bootstrap user is creating their own super_admin profile for the first time.
      allow create: if isSuperAdmin() ||
                     (isSignedIn() && request.resource.data.super_admin == false) ||
                     (
                       isSignedIn() &&
                       request.auth.uid == userId &&
                       request.auth.token.email == 'abengolea1@gmail.com' && 
                       request.resource.data.super_admin == true
                     );

      // Un super admin puede actualizar cualquier perfil.
      // Un usuario puede actualizar su propio documento, pero no darse permisos de super admin.
      allow update: if isSignedIn() && (
        isSuperAdmin() || 
        (request.auth.uid == userId && !('super_admin' in request.resource.data))
      );
    }

    // Intentos de verificación de email para registro web. Acceso sin auth para create/get/update.
    match /emailVerificationAttempts/{attemptId} {
      allow read, write: if true;
    }

    // Mapa email -> schoolId para saber si un usuario tiene pendingPlayer (registro web).
    match /pendingPlayerByEmail/{emailKey} {
      allow create: if isSignedIn() && request.auth.token.email != null
          && emailKey == request.auth.token.email.lower();
      allow read: if isSignedIn() && request.auth.token.email != null
          && emailKey == request.auth.token.email.lower();
      allow delete: if isSuperAdmin() || (resource != null && resource.data.schoolId != null
          && (isSchoolAdmin(resource.data.schoolId) || isOperador(resource.data.schoolId)));
    }

    match /schools/{schoolId} {
      allow read: if true;
      allow create, update: if isSuperAdmin();
      allow delete: if false; // Soft delete
    }
    
    match /schools/{schoolId}/users/{userId} {
        // A user can read their own user document, an admin of that school can read any, and a super admin can read any.
        allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || request.auth.uid == userId;
        // Admins can write, but only valid roles.
        allow create, update: if (isSuperAdmin() || isSchoolAdmin(schoolId)) && isValidSchoolUserRole(request.resource.data.role);
        allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/players/{playerId} {
      // Jugador puede leer su documento si el email coincide o si tiene playerLogin para este jugador (doc sin email aún).
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || (isSignedIn() && request.auth.token.email != null && resource.data.get('email', '').lower() == request.auth.token.email.lower())
          || hasPlayerLoginFor(schoolId, playerId);
      // Solo staff crea jugadores; staff o jugador (email en request = auth email, o playerLogin) pueden actualizar.
      allow create: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
      allow update: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || requestEmailMatchesAuth(schoolId, playerId)
          || hasPlayerLoginFor(schoolId, playerId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/pendingPlayers/{pendingId} {
        // Super admin, miembros de la escuela, o admins/entrenadores pueden leer y eliminar.
        allow read, delete: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isOperador(schoolId);
        // Allow any signed-in user to create a request. This can be tightened later if needed.
        allow create: if isSignedIn();
    }

    match /schools/{schoolId}/evaluations/{evalId} {
      allow get, list: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || isOwnPlayer(schoolId, resource.data.playerId);
      // Cualquier miembro de la escuela (admin o coach) puede crear/editar/borrar evaluaciones.
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId) || isMemberOfSchool(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }

    // --- Other collections ---

    match /schools/{schoolId}/trainings/{trainingId} {
      // Jugadores necesitan listar entrenamientos para ver su asistencia; permitir lectura a cualquier usuario autenticado.
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || isSignedIn();
      allow create, update, delete: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }

    match /schools/{schoolId}/trainings/{trainingId}/attendance/{playerId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId)
          || isOwnPlayer(schoolId, playerId);
      allow write: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }
    
    match /schools/{schoolId}/invites/{inviteId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
     match /schools/{schoolId}/testTemplates/{templateId} {
        allow read: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isOperador(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/reportRuns/{runId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    match /schools/{schoolId}/reports/{reportId} {
        allow read: if isSuperAdmin()
            || isMemberOfSchool(schoolId)
            || isSchoolAdmin(schoolId)
            || isOperador(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // Configuración de evaluaciones físicas (tests habilitados por edad)
    match /schools/{schoolId}/physicalAssessmentConfig/{configId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId);
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // Evaluaciones físicas por jugador
    match /schools/{schoolId}/physicalAssessments/{assessmentId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || isOwnPlayer(schoolId, resource.data.playerId);
      allow create, update, delete: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }

    // Videoteca: videos por jugador (grabados/subidos por el entrenador)
    match /schools/{schoolId}/playerVideos/{videoId} {
      allow read: if isSuperAdmin()
          || isMemberOfSchool(schoolId)
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || isOwnPlayer(schoolId, resource.data.playerId);
      allow create, update, delete: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }

    // --- Pagos y Morosidad ---

    // Pagos: admin de escuela puede leer pagos de su schoolId; padre solo de su jugador. Escritura solo desde servidor (Admin SDK).
    match /payments/{paymentId} {
      allow read: if isSignedIn() && (
        isSuperAdmin()
        || (resource.data.schoolId != null && isSchoolAdmin(resource.data.schoolId))
        || (resource.data.schoolId != null && resource.data.playerId != null && isOwnPlayer(resource.data.schoolId, resource.data.playerId))
      );
      allow write: if false;
    }

    // Intenciones de pago: mismo criterio que payments.
    match /paymentIntents/{intentId} {
      allow read: if isSignedIn() && (
        isSuperAdmin()
        || (resource.data.schoolId != null && isSchoolAdmin(resource.data.schoolId))
        || (resource.data.schoolId != null && resource.data.playerId != null && isOwnPlayer(resource.data.schoolId, resource.data.playerId))
      );
      allow write: if false;
    }

    // Eventos de email (idempotencia): solo servidor escribe; cliente no accede.
    match /emailEvents/{eventId} {
      allow read, write: if false;
    }

    // Pagos no aplicados (Aplicada=No) con observaciones. Solo Admin SDK vía API.
    match /schools/{schoolId}/unappliedPayments/{docId} {
      allow read, write: if false;
    }

    // Configuración de cuotas por escuela
    match /schools/{schoolId}/paymentConfig/{configId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId);
      allow delete: if false;
    }

    // Configuración de mensualidad de escuela a plataforma (solo super admin escribe)
    match /schools/{schoolId}/schoolFeeConfig/{configId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
      allow create, update: if isSuperAdmin();
      allow delete: if false;
    }

    // Pagos de mensualidad de escuelas a la plataforma (solo servidor escribe; super admin y escuela leen)
    match /schoolFeePayments/{paymentId} {
      allow read: if isSuperAdmin()
        || (resource.data.schoolId != null && isSchoolAdmin(resource.data.schoolId))
        || (resource.data.schoolId != null && isOperador(resource.data.schoolId));
      allow write: if false;
    }

    // Configuración de precios de embarcaciones por náutica
    match /schools/{schoolId}/boatPricingConfig/{configId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId);
      allow delete: if false;
    }

    // Configuración de turnos por náutica (admin configura; clientes leen si está habilitado)
    match /schools/{schoolId}/appointmentConfig/{configId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId)
          || (isMemberOfSchool(schoolId) && resource.data.get('enabled', false) == true);
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId);
      allow delete: if false;
    }

    // Turnos reservados: admin/coach leen todos; cliente crea y lee los suyos (por playerId)
    match /schools/{schoolId}/appointments/{appointmentId} {
      allow read: if isSuperAdmin()
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || (isMemberOfSchool(schoolId) && resource.data.playerId != null
              && (isOwnPlayer(schoolId, resource.data.playerId)
                  || hasPlayerLoginFor(schoolId, resource.data.playerId)));
      allow create: if isSuperAdmin()
          || isSchoolAdmin(schoolId)
          || isOperador(schoolId)
          || (isMemberOfSchool(schoolId) && request.resource.data.playerId != null
              && request.resource.data.schoolId == schoolId
              && (isOwnPlayer(schoolId, request.resource.data.playerId)
                  || hasPlayerLoginFor(schoolId, request.resource.data.playerId)));
      allow update, delete: if isSuperAdmin() || isSchoolAdmin(schoolId) || isOperador(schoolId);
    }

    // Conexión OAuth Mercado Pago por escuela (tokens; solo servidor debería escribir en producción)
    match /schools/{schoolId}/mercadopagoConnection/{docId} {
      allow read: if isSuperAdmin() || isSchoolAdmin(schoolId);
      allow create, update: if isSuperAdmin() || isSchoolAdmin(schoolId);
      allow delete: if false;
    }

    // --- Centro de Soporte (Support Center) ---

    // Flujos guiados: lectura para cualquier autenticado; escritura solo superadmin.
    match /supportFlows/{flowId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    // Conversaciones de soporte por escuela: el usuario crea/actualiza la suya; admins pueden leer.
    match /schools/{schoolId}/supportConversations/{conversationId} {
      allow read: if isMemberOfSchool(schoolId)
          && (resource.data.userId == request.auth.uid || isSchoolAdmin(schoolId) || isSuperAdmin());
      allow create: if isMemberOfSchool(schoolId) && request.resource.data.userId == request.auth.uid;
      allow update: if isMemberOfSchool(schoolId)
          && (resource.data.userId == request.auth.uid || isSchoolAdmin(schoolId) || isSuperAdmin());
      allow delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // Contador de tickets por escuela (para número secuencial en transacción).
    match /schools/{schoolId}/supportTicketCounter/counter {
      allow read, update: if isMemberOfSchool(schoolId);
      allow create: if isMemberOfSchool(schoolId);
      allow delete: if false;
    }

    // Tickets de soporte por escuela: usuario crea y lee los suyos; solo operador (school_admin/superadmin) actualiza.
    // Tickets de soporte técnico: solo superadmin puede actualizar (resolver, asignar, notas).
    match /schools/{schoolId}/supportTickets/{ticketId} {
      allow read: if isMemberOfSchool(schoolId)
          && (resource.data.userId == request.auth.uid || isSuperAdmin());
      allow create: if isMemberOfSchool(schoolId) && request.resource.data.userId == request.auth.uid;
      allow update: if isSuperAdmin();
      allow delete: if false;
    }

    // Eventos de auditoría del ticket: solo superadmin crea al actualizar ticket.
    match /schools/{schoolId}/supportTickets/{ticketId}/supportTicketEvents/{eventId} {
      allow read: if isMemberOfSchool(schoolId)
          && (get(/databases/$(database)/documents/schools/$(schoolId)/supportTickets/$(ticketId)).data.userId == request.auth.uid
              || isSuperAdmin());
      allow create: if isSuperAdmin();
      allow update, delete: if false;
    }

    // --- Configuración global y auditoría (solo super admin) ---

    match /platformConfig/{configId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /auditLog/{entryId} {
      allow read: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update, delete: if false;
    }

    // --- Conciliación de Pagos (solo Admin SDK vía API; cliente no accede directo) ---
    match /schools/{schoolId}/recClients/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recPayments/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recMatches/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recPayerAliases/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recPendingPayerAliases/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recImportBatches/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recExcelRelations/{docId} {
      allow read, write: if false;
    }
    match /schools/{schoolId}/recExcelAudit/{docId} {
      allow read, write: if false;
    }

    // --- Gastos (expenses) ---
    match /schools/{schoolId}/expenses/{expenseId} {
      allow read: if isStaffOfSchool(schoolId);
      allow write: if false;  // Solo Admin SDK vía API
    }
    match /schools/{schoolId}/expenseVendors/{vendorId} {
      allow read: if isStaffOfSchool(schoolId);
      allow write: if false;  // Solo Admin SDK vía API
    }
    match /schools/{schoolId}/vendorAccounts/{vendorId}/entries/{entryId} {
      allow read: if isStaffOfSchool(schoolId);
      allow write: if false;  // Solo Admin SDK vía API
    }
    match /schools/{schoolId}/expensePayments/{paymentId} {
      allow read: if isStaffOfSchool(schoolId);
      allow write: if false;  // Solo Admin SDK vía API
    }

    // --- Notas (posts) ---
    // Lectura: públicos si published; staff de la escuela si draft/archived
    match /posts/{postId} {
      allow read: if resource.data.status == 'published'
        || (isSignedIn() && resource.data.schoolId != null && isStaffOfSchool(resource.data.schoolId));
      allow write: if false;  // Solo Admin SDK vía API routes
    }
  }
}
